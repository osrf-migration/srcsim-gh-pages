{"links": {"self": {"href": "data/repositories/osrf/srcsim/issues/146/comments/37417855.json"}, "html": {"href": "#!/osrf/srcsim/issues/146#comment-37417855"}}, "issue": {"links": {"self": {"href": "data/repositories/osrf/srcsim/issues/146.json"}}, "type": "issue", "id": 146, "repository": {"links": {"self": {"href": "data/repositories/osrf/srcsim.json"}, "html": {"href": "#!/osrf/srcsim"}, "avatar": {"href": "data/bytebucket.org/ravatar/{c41021d9-0217-4628-999d-7f8d82f98dcb}ts=c_plus_plus"}}, "type": "repository", "name": "srcsim", "full_name": "osrf/srcsim", "uuid": "{c41021d9-0217-4628-999d-7f8d82f98dcb}"}, "title": "traffic control parameters"}, "content": {"raw": "I followed up by running a variant of the old script, which got things flowing again. I ran `sudo ./start_tc.rb -i eth0 -d 50kbit -u 50kbit -l 20ms` on the script below.  Afterwards, I ran the new example script again, and lo and behold, it worked.  I ran \n`sudo ./src_tc.rb -i eth0 -d 50mbit -u 50mbit -f 192.168.2.150/26 -l 15ms` and saw pings of 30ms between machines, and iperf showed a 50mbit connection.   There must be a critical setting in the old script still (or the variant I made).\n\nThe script is:\n```\n#!/usr/bin/env ruby\n\nrequire 'optparse'\n\n# The physical interface\niface = ARGV[0]\n\n# Downlink bandwidth limit\ndownlinkBandwidth = \"1mbit\"\n\n# Uplink bandwidth limit\nuplinkBandwidth = \"100mbit\"\n\n# Default options\noptions = {:iface => \"eth0\", :downlink => \"100mb\", :uplink => \"10mb\", :latency => \"100\"}\n\nOptionParser.new do |opts|\n  opts.banner = \"Usage: sudo ./src_tc.rb [options]\\n\\n\" +\n    \"A bandwidth value must have one of the following suffixes:\\n\" +\n    \"  b\\t\\tBytes\\n\" +\n    \"  kbit\\t\\tKilobits\\n\"+\n    \"  k, or kb\\tKilobytes\\n\"+\n    \"  mbit\\t\\tMegabits\\n\" +\n    \"  m, or mb\\tMegabits\\n\" +\n    \"  gbit\\t\\tGigabits\" +\n    \"  g, or gb\\t Gigabytes\\n\\n\" +\n    \"Example:\\n  sudo ./src_tc.rb -i eth0 -d 100mbit -u 10kb -l 100ms \\n\\n\" +\n    \"Options:\"\n\n  opts.on('-i', '--iface INTERFACE', \"Ethernet interface name. Default=#{options[:iface]}\") { |v|\n    options[:iface] = v\n  }\n\n  opts.on('-d', '--downlink BANDWIDTH', \"Downlink bandwidth. Default=#{options[:downlink]}\") { |v|\n    options[:downlink] = v\n  }\n\n  opts.on('-u', '--uplink BANDWIDTH', \"Uplink bandwidth. Default=#{options[:uplink]}\") { |v|\n    options[:uplink] = v\n  }\n  opts.on('-l', '--latency Delay', \"Round trip latency in ms. Default=#{options[:latency]}\") { |v|\n    options[:latency] = v\n  }\n\nend.parse!\n\n# Clear tc\n`tc qdisc del dev #{options[:iface]} root`\n`tc qdisc del dev ifb0 root`\n\n# Insert the ifb module so that we can redirect incoming (ingress) traffic\n# to a virtual interface. This will allow us to apply a bandwidth limit to\n# incoming traffic. Bandwidth limits can only be applied to send queues.\n# This is why we must redirect incoming traffic to a virtual interface, and\n# then limit the virtual interface's outbound queue.\n`modprobe ifb numifbs=1`\n\n# Create the virtual interface\n`ip link set dev ifb0 up`\n# Redirect ingress traffic from the physical interface to the virtual\n# interface.\n`tc qdisc add dev #{options[:iface]} root netem delay #{options[:latency]}`\n`tc qdisc add dev #{options[:iface]} handle ffff: ingress`\n`tc filter add dev #{options[:iface]} parent ffff: protocol ip u32 match u32 0 0 action mirred egress redirect dev ifb0`\n\n# Apply egress (uplink) rules for the physical interface\n`tc qdisc add dev #{options[:iface]} root handle 1: htb default 10`\n`tc class add dev #{options[:iface]} parent 1: classid 1:1 htb rate #{options[:uplink]}`\n`tc class add dev #{options[:iface]} parent 1:1 classid 1:10 htb rate #{options[:uplink]}`\n\n# Apply ingress (downlink) rules for the physical interface\n# via egress rules for the virtual interface.\n`tc qdisc add dev ifb0 root handle 1: htb default 10`\n`tc class add dev ifb0 parent 1: classid 1:1 htb rate #{options[:downlink]}`\n`tc class add dev ifb0 parent 1:1 classid 1:10 htb rate #{options[:downlink]}`\n\n```", "markup": "markdown", "html": "<p>I followed up by running a variant of the old script, which got things flowing again. I ran <code>sudo ./start_tc.rb -i eth0 -d 50kbit -u 50kbit -l 20ms</code> on the script below.  Afterwards, I ran the new example script again, and lo and behold, it worked.  I ran \n<code>sudo ./src_tc.rb -i eth0 -d 50mbit -u 50mbit -f 192.168.2.150/26 -l 15ms</code> and saw pings of 30ms between machines, and iperf showed a 50mbit connection.   There must be a critical setting in the old script still (or the variant I made).</p>\n<p>The script is:</p>\n<div class=\"codehilite language-ruby\"><pre><span></span><span class=\"ch\">#!/usr/bin/env ruby</span>\n\n<span class=\"nb\">require</span> <span class=\"s1\">&#39;optparse&#39;</span>\n\n<span class=\"c1\"># The physical interface</span>\n<span class=\"n\">iface</span> <span class=\"o\">=</span> <span class=\"no\">ARGV</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n\n<span class=\"c1\"># Downlink bandwidth limit</span>\n<span class=\"n\">downlinkBandwidth</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;1mbit&quot;</span>\n\n<span class=\"c1\"># Uplink bandwidth limit</span>\n<span class=\"n\">uplinkBandwidth</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;100mbit&quot;</span>\n\n<span class=\"c1\"># Default options</span>\n<span class=\"n\">options</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"ss\">:iface</span> <span class=\"o\">=&gt;</span> <span class=\"s2\">&quot;eth0&quot;</span><span class=\"p\">,</span> <span class=\"ss\">:downlink</span> <span class=\"o\">=&gt;</span> <span class=\"s2\">&quot;100mb&quot;</span><span class=\"p\">,</span> <span class=\"ss\">:uplink</span> <span class=\"o\">=&gt;</span> <span class=\"s2\">&quot;10mb&quot;</span><span class=\"p\">,</span> <span class=\"ss\">:latency</span> <span class=\"o\">=&gt;</span> <span class=\"s2\">&quot;100&quot;</span><span class=\"p\">}</span>\n\n<span class=\"no\">OptionParser</span><span class=\"o\">.</span><span class=\"n\">new</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">opts</span><span class=\"o\">|</span>\n  <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">banner</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;Usage: sudo ./src_tc.rb [options]</span><span class=\"se\">\\n\\n</span><span class=\"s2\">&quot;</span> <span class=\"o\">+</span>\n    <span class=\"s2\">&quot;A bandwidth value must have one of the following suffixes:</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span> <span class=\"o\">+</span>\n    <span class=\"s2\">&quot;  b</span><span class=\"se\">\\t\\t</span><span class=\"s2\">Bytes</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span> <span class=\"o\">+</span>\n    <span class=\"s2\">&quot;  kbit</span><span class=\"se\">\\t\\t</span><span class=\"s2\">Kilobits</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"o\">+</span>\n    <span class=\"s2\">&quot;  k, or kb</span><span class=\"se\">\\t</span><span class=\"s2\">Kilobytes</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"o\">+</span>\n    <span class=\"s2\">&quot;  mbit</span><span class=\"se\">\\t\\t</span><span class=\"s2\">Megabits</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span> <span class=\"o\">+</span>\n    <span class=\"s2\">&quot;  m, or mb</span><span class=\"se\">\\t</span><span class=\"s2\">Megabits</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span> <span class=\"o\">+</span>\n    <span class=\"s2\">&quot;  gbit</span><span class=\"se\">\\t\\t</span><span class=\"s2\">Gigabits&quot;</span> <span class=\"o\">+</span>\n    <span class=\"s2\">&quot;  g, or gb</span><span class=\"se\">\\t</span><span class=\"s2\"> Gigabytes</span><span class=\"se\">\\n\\n</span><span class=\"s2\">&quot;</span> <span class=\"o\">+</span>\n    <span class=\"s2\">&quot;Example:</span><span class=\"se\">\\n</span><span class=\"s2\">  sudo ./src_tc.rb -i eth0 -d 100mbit -u 10kb -l 100ms </span><span class=\"se\">\\n\\n</span><span class=\"s2\">&quot;</span> <span class=\"o\">+</span>\n    <span class=\"s2\">&quot;Options:&quot;</span>\n\n  <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">on</span><span class=\"p\">(</span><span class=\"s1\">&#39;-i&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--iface INTERFACE&#39;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Ethernet interface name. Default=</span><span class=\"si\">#{</span><span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:iface</span><span class=\"o\">]</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"o\">|</span><span class=\"n\">v</span><span class=\"o\">|</span>\n    <span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:iface</span><span class=\"o\">]</span> <span class=\"o\">=</span> <span class=\"n\">v</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">on</span><span class=\"p\">(</span><span class=\"s1\">&#39;-d&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--downlink BANDWIDTH&#39;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Downlink bandwidth. Default=</span><span class=\"si\">#{</span><span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:downlink</span><span class=\"o\">]</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"o\">|</span><span class=\"n\">v</span><span class=\"o\">|</span>\n    <span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:downlink</span><span class=\"o\">]</span> <span class=\"o\">=</span> <span class=\"n\">v</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">on</span><span class=\"p\">(</span><span class=\"s1\">&#39;-u&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--uplink BANDWIDTH&#39;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Uplink bandwidth. Default=</span><span class=\"si\">#{</span><span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:uplink</span><span class=\"o\">]</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"o\">|</span><span class=\"n\">v</span><span class=\"o\">|</span>\n    <span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:uplink</span><span class=\"o\">]</span> <span class=\"o\">=</span> <span class=\"n\">v</span>\n  <span class=\"p\">}</span>\n  <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">on</span><span class=\"p\">(</span><span class=\"s1\">&#39;-l&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--latency Delay&#39;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Round trip latency in ms. Default=</span><span class=\"si\">#{</span><span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:latency</span><span class=\"o\">]</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"o\">|</span><span class=\"n\">v</span><span class=\"o\">|</span>\n    <span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:latency</span><span class=\"o\">]</span> <span class=\"o\">=</span> <span class=\"n\">v</span>\n  <span class=\"p\">}</span>\n\n<span class=\"k\">end</span><span class=\"o\">.</span><span class=\"n\">parse!</span>\n\n<span class=\"c1\"># Clear tc</span>\n<span class=\"sb\">`tc qdisc del dev </span><span class=\"si\">#{</span><span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:iface</span><span class=\"o\">]</span><span class=\"si\">}</span><span class=\"sb\"> root`</span>\n<span class=\"sb\">`tc qdisc del dev ifb0 root`</span>\n\n<span class=\"c1\"># Insert the ifb module so that we can redirect incoming (ingress) traffic</span>\n<span class=\"c1\"># to a virtual interface. This will allow us to apply a bandwidth limit to</span>\n<span class=\"c1\"># incoming traffic. Bandwidth limits can only be applied to send queues.</span>\n<span class=\"c1\"># This is why we must redirect incoming traffic to a virtual interface, and</span>\n<span class=\"c1\"># then limit the virtual interface&#39;s outbound queue.</span>\n<span class=\"sb\">`modprobe ifb numifbs=1`</span>\n\n<span class=\"c1\"># Create the virtual interface</span>\n<span class=\"sb\">`ip link set dev ifb0 up`</span>\n<span class=\"c1\"># Redirect ingress traffic from the physical interface to the virtual</span>\n<span class=\"c1\"># interface.</span>\n<span class=\"sb\">`tc qdisc add dev </span><span class=\"si\">#{</span><span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:iface</span><span class=\"o\">]</span><span class=\"si\">}</span><span class=\"sb\"> root netem delay </span><span class=\"si\">#{</span><span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:latency</span><span class=\"o\">]</span><span class=\"si\">}</span><span class=\"sb\">`</span>\n<span class=\"sb\">`tc qdisc add dev </span><span class=\"si\">#{</span><span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:iface</span><span class=\"o\">]</span><span class=\"si\">}</span><span class=\"sb\"> handle ffff: ingress`</span>\n<span class=\"sb\">`tc filter add dev </span><span class=\"si\">#{</span><span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:iface</span><span class=\"o\">]</span><span class=\"si\">}</span><span class=\"sb\"> parent ffff: protocol ip u32 match u32 0 0 action mirred egress redirect dev ifb0`</span>\n\n<span class=\"c1\"># Apply egress (uplink) rules for the physical interface</span>\n<span class=\"sb\">`tc qdisc add dev </span><span class=\"si\">#{</span><span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:iface</span><span class=\"o\">]</span><span class=\"si\">}</span><span class=\"sb\"> root handle 1: htb default 10`</span>\n<span class=\"sb\">`tc class add dev </span><span class=\"si\">#{</span><span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:iface</span><span class=\"o\">]</span><span class=\"si\">}</span><span class=\"sb\"> parent 1: classid 1:1 htb rate </span><span class=\"si\">#{</span><span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:uplink</span><span class=\"o\">]</span><span class=\"si\">}</span><span class=\"sb\">`</span>\n<span class=\"sb\">`tc class add dev </span><span class=\"si\">#{</span><span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:iface</span><span class=\"o\">]</span><span class=\"si\">}</span><span class=\"sb\"> parent 1:1 classid 1:10 htb rate </span><span class=\"si\">#{</span><span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:uplink</span><span class=\"o\">]</span><span class=\"si\">}</span><span class=\"sb\">`</span>\n\n<span class=\"c1\"># Apply ingress (downlink) rules for the physical interface</span>\n<span class=\"c1\"># via egress rules for the virtual interface.</span>\n<span class=\"sb\">`tc qdisc add dev ifb0 root handle 1: htb default 10`</span>\n<span class=\"sb\">`tc class add dev ifb0 parent 1: classid 1:1 htb rate </span><span class=\"si\">#{</span><span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:downlink</span><span class=\"o\">]</span><span class=\"si\">}</span><span class=\"sb\">`</span>\n<span class=\"sb\">`tc class add dev ifb0 parent 1:1 classid 1:10 htb rate </span><span class=\"si\">#{</span><span class=\"n\">options</span><span class=\"o\">[</span><span class=\"ss\">:downlink</span><span class=\"o\">]</span><span class=\"si\">}</span><span class=\"sb\">`</span>\n</pre></div>", "type": "rendered"}, "created_on": "2017-06-07T01:45:43.290509+00:00", "user": {"display_name": "Steven Gray", "uuid": "{7470e809-c304-4b17-b986-685f31fa15c3}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B7470e809-c304-4b17-b986-685f31fa15c3%7D"}, "html": {"href": "https://bitbucket.org/%7B7470e809-c304-4b17-b986-685f31fa15c3%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/e6bee642b76507eb51c2839771722e68d=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsSG-0.png"}}, "nickname": "stgray", "type": "user", "account_id": "557058:e6cc7c7b-9d1b-4abe-87d5-5f0da7c863e1"}, "updated_on": null, "type": "issue_comment", "id": 37417855}